<p id="stat"></p>

<div class="section">
    <textarea id="offer" placeholder="Paste offer here. And press Enter"></textarea>
</div>

<div class="section">
    <textarea id="answer" placeholder="Paste offer here. And press Enter"></textarea>
</div>



<div class="section">
    <input id="chat" placeholder="Chat"><br>
    <pre id="output">Chat: </pre>
</div>
<script>

    let offer = document.getElementById('offer');

    function hexToBase64(hex) {
        const bytes = [];
        for (let i = 0; i < hex.length; i += 2) {
            bytes.push(parseInt(hex.substring(i, i +2), 16));
        }
        let binaryString = String.fromCharCode.apply(null, bytes)
        return btoa(binaryString).replaceAll(/=+$/g, "");
    }

    function ipv6ToBase64(ipv6) {
        const bytes = [];
        const segments = ipv6.split(':').map(segment => segment.padStart(4, '0'));
        for (let hexSegment of segments) {
            for (let i = 0; i < hexSegment.length; i += 2) {
                bytes.push(parseInt(hexSegment.substring(i, i+2), 16));
            }
        }
        let binaryString = String.fromCharCode(...new Uint8Array(bytes));
        return btoa(binaryString).replaceAll(/=+$/g, "");
    }

    async function acceptOffer() {
        if (pc.signalingState != "stable") return;
        console.log("Accepting offer...", offer.value)

        await pc.setRemoteDescription({
            type: "offer",
            sdp: offer.value
        });
        await pc.setLocalDescription(await pc.createAnswer());
        pc.onicecandidate = ({ candidate }) => {
            if (candidate) return;
            answer.focus();
            let sdp = pc.localDescription.sdp;
            // Cleanup Candidates

            console.log("SDP:");
            sdp = sdp.replaceAll("\r\n", "\n")

            console.log(sdp)

            sdp = sdp.replaceAll(/a=candidate.+\.local.+\n/g, ""); // no local
            sdp = sdp.replaceAll(/a=candidate:.+typ (?!srflx|host).+\n/g, ""); // must contain srflx or host

            let fingerPrint = hexToBase64(/a=fingerprint:sha-256 (.+)\n/g.exec(sdp)[1].replaceAll(":", ""));
            let icePwd = hexToBase64(/a=ice-pwd:(.+)\n/g.exec(sdp)[1]);
            let iceUfrag = hexToBase64(/a=ice-ufrag:(.+)\n/g.exec(sdp)[1]);
            let shortSdp = `${fingerPrint}.${icePwd}.${iceUfrag}`
            let candidatePattern = /a=candidate:([0-9]+) 1 UDP [0-9]+ ([^ ]+) ([0-9]+) typ (srflx|host) .+\n/g;
            let match;
            while (match = candidatePattern.exec(sdp)) {
                let id = match[1];
                let ip = match[2]
                let port = match[3];
                let type = match[4];
                type = type === "srflx" ? type = "s" : type = "h";
                if (ip.includes(":")) {
                    shortSdp += '.6' + type + ipv6ToBase64(ip) + ":" + port + "#" + id;
                } else {
                    shortSdp += '.4' + type + btoa(ip + ":" + port).replaceAll("=+$", "") + "#" + id
                }
            }

            console.log(shortSdp)
            console.log(btoa(shortSdp))
            answer.value = shortSdp;

            answer.select();
        };
    }



    let chat = document.getElementById('chat');
    let answer = document.getElementById('answer');
    const output = document.getElementById('output');
    let channel;

    const log = msg => output.innerHTML += `<br>${msg}`;


    const config = {
        iceServers: [{
            urls: "stun:stun.l.google.com:19302" // list of free STUN servers: https://gist.github.com/zziuni/3741933
        }]
    };
    const pc = new RTCPeerConnection(config);
    pc.ondatachannel = (event) => {
        channel = event.channel;
        channel.onopen = e => {
            console.log("We are connected!")
        };
        channel.onmessage = (event) => {
            log(event.data);
        };
    };

    pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);

    chat.onkeypress = function (e) {
        if (e.keyCode != 13) return;
        channel.send(chat.value);
        log(chat.value);
        chat.value = "";
    };


    offer.onkeyup = acceptOffer

    // answer.onkeypress = function (e) {
    //     if (e.keyCode != 13 || pc.signalingState != "have-local-offer") return;
    //     answer.disabled = true;
    //     pc.setRemoteDescription({
    //         type: "answer",
    //         sdp: answer.value
    //     });
    // };

    // copyButton.onclick = function (e) {
    //     let answerVal = answer.value;
    //     answerVal = answerVal.replaceAll(/a=candidate.+\.local.+\n/g, "")
    //     console.log(answerVal, answerVal.length);
    //     let base64 = btoa(answerVal);
    //     console.log(base64, base64.length);
    //     navigator.clipboard.writeText(base64)
    // }

    pc.onconnectionstatechange = ev => handleChange();
    pc.oniceconnectionstatechange = ev => handleChange();

    function handleChange() {
        let stat = 'ConnectionState: <strong>' + pc.connectionState + '</strong> IceConnectionState: <strong>' + pc.iceConnectionState + '</strong>';
        document.getElementById('stat').innerHTML = stat;
        console.log('%c' + new Date().toISOString() + ': ConnectionState: %c' + pc.connectionState + ' %cIceConnectionState: %c' + pc.iceConnectionState,
            'color:yellow', 'color:orange', 'color:yellow', 'color:orange');
    }

    handleChange();


    var params = new URLSearchParams(window.location.search);
    let sdpValue = params.get("sdp");
    if (sdpValue) {
        sdpValue = atob(sdpValue)
        console.log(sdpValue)
        offer.value = sdpValue;
        acceptOffer();
    }

</script>



<style>
    body {
        background-color: #2b2b2b;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .section {
        width: 100%;
        max-width: 600px; /* Limit maximum width */
        margin-bottom: 20px; /* Spacing between sections */
    }

    textarea, #chat {
        background-color: #3f3f3f;
        color: #e0e0e0;
        border: 1px solid #5c5c5c;
        padding: 8px;
        width: 100%; /* Full width */
        resize: vertical; /* Allow vertical resizing */
    }

    #offer {
        height: 150px; /* Set height as needed */
    }

    .answer-container {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }

    #answer {
        flex: 1; /* Take remaining space */
        margin-right: 10px;
        height: 150px; /* Set height as needed */
    }

    #copyButton {
        background-color: #3f3f3f;
        color: #ffffff;
        padding: 8px 16px;
        border: none;
        cursor: pointer;
    }

    #output {
        background-color: #3f3f3f;
        color: #e0e0e0;
        padding: 10px;
        border: 1px solid #5c5c5c;
        width: 100%;
        overflow-y: auto; /* Enable vertical scrollbar if needed */
        margin-top: 10px;
    }


</style>
