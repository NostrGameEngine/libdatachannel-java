<p id="stat"></p>

<div class="section">
    <textarea id="offer" placeholder="Paste offer here. And press Enter"></textarea>
</div>

<div class="section">
    <textarea id="answer" placeholder="Paste offer here. And press Enter"></textarea>
</div>



<div class="section">
    <input id="chat" placeholder="Chat"><br>
    <pre id="output">Chat: </pre>
</div>
<script>

    let offer = document.getElementById('offer');

    async function acceptOffer() {
        if (pc.signalingState != "stable") return;
        console.log("Accepting offer...", offer.value)

        await pc.setRemoteDescription({
            type: "offer",
            sdp: offer.value
        });
        await pc.setLocalDescription(await pc.createAnswer());
        pc.onicecandidate = ({
                                 candidate
                             }) => {
            if (candidate) return;
            answer.focus();
            answer.value = pc.localDescription.sdp;
            answer.select();
        };
    }



    let chat = document.getElementById('chat');
    let answer = document.getElementById('answer');
    const output = document.getElementById('output');
    let channel;

    const log = msg => output.innerHTML += `<br>${msg}`;


    const config = {
        iceServers: [{
            urls: "stun:stun.l.google.com:19302" // list of free STUN servers: https://gist.github.com/zziuni/3741933
        }]
    };
    const pc = new RTCPeerConnection(config);
    pc.ondatachannel = (event) => {
        channel = event.channel;
        channel.onopen = e => {
            console.log("We are connected!")
        };
        channel.onmessage = (event) => {
            log(event.data);
        };
    };

    pc.oniceconnectionstatechange = e => log(pc.iceConnectionState);

    chat.onkeypress = function (e) {
        if (e.keyCode != 13) return;
        channel.send(chat.value);
        log(chat.value);
        chat.value = "";
    };


    offer.onkeyup = acceptOffer

    // answer.onkeypress = function (e) {
    //     if (e.keyCode != 13 || pc.signalingState != "have-local-offer") return;
    //     answer.disabled = true;
    //     pc.setRemoteDescription({
    //         type: "answer",
    //         sdp: answer.value
    //     });
    // };

    // copyButton.onclick = function (e) {
    //     let answerVal = answer.value;
    //     answerVal = answerVal.replaceAll(/a=candidate.+\.local.+\n/g, "")
    //     console.log(answerVal, answerVal.length);
    //     let base64 = btoa(answerVal);
    //     console.log(base64, base64.length);
    //     navigator.clipboard.writeText(base64)
    // }

    pc.onconnectionstatechange = ev => handleChange();
    pc.oniceconnectionstatechange = ev => handleChange();

    function handleChange() {
        let stat = 'ConnectionState: <strong>' + pc.connectionState + '</strong> IceConnectionState: <strong>' + pc.iceConnectionState + '</strong>';
        document.getElementById('stat').innerHTML = stat;
        console.log('%c' + new Date().toISOString() + ': ConnectionState: %c' + pc.connectionState + ' %cIceConnectionState: %c' + pc.iceConnectionState,
            'color:yellow', 'color:orange', 'color:yellow', 'color:orange');
    }

    handleChange();


    var params = new URLSearchParams(window.location.search);
    let sdpValue = params.get("sdp");
    if (sdpValue) {
        sdpValue = atob(sdpValue)
        console.log(sdpValue)
        offer.value = sdpValue;
        acceptOffer();
    }

</script>



<style>
    body {
        background-color: #2b2b2b;
        color: #e0e0e0;
        font-family: Arial, sans-serif;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
    }

    .section {
        width: 100%;
        max-width: 600px; /* Limit maximum width */
        margin-bottom: 20px; /* Spacing between sections */
    }

    textarea, #chat {
        background-color: #3f3f3f;
        color: #e0e0e0;
        border: 1px solid #5c5c5c;
        padding: 8px;
        width: 100%; /* Full width */
        resize: vertical; /* Allow vertical resizing */
    }

    #offer {
        height: 150px; /* Set height as needed */
    }

    .answer-container {
        display: flex;
        align-items: center;
        margin-top: 10px;
    }

    #answer {
        flex: 1; /* Take remaining space */
        margin-right: 10px;
        height: 150px; /* Set height as needed */
    }

    #copyButton {
        background-color: #3f3f3f;
        color: #ffffff;
        padding: 8px 16px;
        border: none;
        cursor: pointer;
    }

    #output {
        background-color: #3f3f3f;
        color: #e0e0e0;
        padding: 10px;
        border: 1px solid #5c5c5c;
        width: 100%;
        overflow-y: auto; /* Enable vertical scrollbar if needed */
        margin-top: 10px;
    }


</style>
